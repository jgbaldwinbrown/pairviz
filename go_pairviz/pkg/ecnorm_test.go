package pairviz

import (
	"encoding/json"
	"os"
	"testing"
	"strings"
)

const gPairvizOutExample = `{"Genome":"A4","Chr":"4","Start":0,"End":100000,"TargetType":"paired","AltType":"self","TargetHits":1117,"AltHits":1756,"TargetProp":0.3887922032718413,"AltProp":0.6112077967281587,"TargetPropGoodBad":0.000007738823666378633,"TargetPropGood":0.000007738802916931488,"TargetPropTotal":0.000007738823666378633,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.07738823666378632,"AltFpkm":0.12165957348398279,"TargetFpkmProp":0.3887922032718412,"AltFpkmProp":0.6112077967281587,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":10000,"End":110000,"TargetType":"paired","AltType":"self","TargetHits":1184,"AltHits":1879,"TargetProp":0.386549134835129,"AltProp":0.613450865164871,"TargetPropGoodBad":0.00000820301452192686,"TargetPropGood":0.000008202992527884406,"TargetPropTotal":0.00000820301452192686,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.08203014521926859,"AltFpkm":0.13018128620524128,"TargetFpkmProp":0.3865491348351289,"AltFpkmProp":0.613450865164871,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":20000,"End":120000,"TargetType":"paired","AltType":"self","TargetHits":1269,"AltHits":2036,"TargetProp":0.38396369137670194,"AltProp":0.6160363086232981,"TargetPropGoodBad":0.000008791913368517891,"TargetPropGood":0.000008791889795511243,"TargetPropTotal":0.000008791913368517891,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.08791913368517891,"AltFpkm":0.14105859431286386,"TargetFpkmProp":0.383963691376702,"AltFpkmProp":0.616036308623298,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":30000,"End":130000,"TargetType":"paired","AltType":"self","TargetHits":1364,"AltHits":2170,"TargetProp":0.38596491228070173,"AltProp":0.6140350877192983,"TargetPropGoodBad":0.000009450094432354928,"TargetPropGood":0.00000945006909462359,"TargetPropTotal":0.000009450094432354928,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.09450094432354927,"AltFpkm":0.1503424114238284,"TargetFpkmProp":0.38596491228070173,"AltFpkmProp":0.6140350877192983,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":40000,"End":140000,"TargetType":"paired","AltType":"self","TargetHits":1416,"AltHits":2216,"TargetProp":0.3898678414096916,"AltProp":0.6101321585903083,"TargetPropGoodBad":0.000009810361962034148,"TargetPropGood":0.000009810335658348243,"TargetPropTotal":0.000009810361962034148,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.09810361962034148,"AltFpkm":0.15352939341714456,"TargetFpkmProp":0.38986784140969166,"AltFpkmProp":0.6101321585903083,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":50000,"End":150000,"TargetType":"paired","AltType":"self","TargetHits":1402,"AltHits":2189,"TargetProp":0.39042049568365356,"AltProp":0.6095795043163464,"TargetPropGoodBad":0.000009713366857889742,"TargetPropGood":0.000009713340814268529,"TargetPropTotal":0.000009713366857889742,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.09713366857889742,"AltFpkm":0.15165877355150248,"TargetFpkmProp":0.39042049568365356,"AltFpkmProp":0.6095795043163464,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":60000,"End":160000,"TargetType":"paired","AltType":"self","TargetHits":1354,"AltHits":2099,"TargetProp":0.3921227917752679,"AltProp":0.6078772082247321,"TargetPropGoodBad":0.000009380812215108924,"TargetPropGood":0.000009380787063138081,"TargetPropTotal":0.000009380812215108924,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.09380812215108923,"AltFpkm":0.14542337399936212,"TargetFpkmProp":0.3921227917752679,"AltFpkmProp":0.6078772082247321,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":70000,"End":170000,"TargetType":"paired","AltType":"self","TargetHits":1315,"AltHits":2058,"TargetProp":0.38986065816780313,"AltProp":0.6101393418321969,"TargetPropGoodBad":0.00000911061156784951,"TargetPropGood":0.00000911058714034459,"TargetPropTotal":0.00000911061156784951,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.09110611567849508,"AltFpkm":0.14258280309227594,"TargetFpkmProp":0.38986065816780313,"AltFpkmProp":0.6101393418321969,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":80000,"End":180000,"TargetType":"paired","AltType":"self","TargetHits":1152,"AltHits":1962,"TargetProp":0.3699421965317919,"AltProp":0.630057803468208,"TargetPropGoodBad":0.000007981311426739647,"TargetPropGood":0.000007981290027130774,"TargetPropTotal":0.000007981311426739647,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.07981311426739646,"AltFpkm":0.1359317102366596,"TargetFpkmProp":0.3699421965317919,"AltFpkmProp":0.630057803468208,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"4","Start":90000,"End":190000,"TargetType":"paired","AltType":"self","TargetHits":1182,"AltHits":2149,"TargetProp":0.354848393875713,"AltProp":0.645151606124287,"TargetPropGoodBad":0.000008189158078477658,"TargetPropGood":0.000008189136121587305,"TargetPropTotal":0.000008189158078477658,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.08189158078477657,"AltFpkm":0.1488874848616623,"TargetFpkmProp":0.354848393875713,"AltFpkmProp":0.645151606124287,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":0,"End":100000,"TargetType":"paired","AltType":"self","TargetHits":2383,"AltHits":4568,"TargetProp":0.34282837001870237,"AltProp":0.6571716299812976,"TargetPropGoodBad":0.000016509952369722724,"TargetPropGood":0.00001650990810299708,"TargetPropTotal":0.000016509952369722724,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.16509952369722722,"AltFpkm":0.31648116837974566,"TargetFpkmProp":0.34282837001870237,"AltFpkmProp":0.6571716299812976,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":10000,"End":110000,"TargetType":"paired","AltType":"self","TargetHits":2556,"AltHits":4541,"TargetProp":0.3601521769761871,"AltProp":0.6398478230238129,"TargetPropGoodBad":0.00001770853472807859,"TargetPropGood":0.000017708487247696404,"TargetPropTotal":0.00001770853472807859,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.1770853472807859,"AltFpkm":0.3146105485141036,"TargetFpkmProp":0.3601521769761871,"AltFpkmProp":0.6398478230238128,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":20000,"End":120000,"TargetType":"paired","AltType":"self","TargetHits":2745,"AltHits":4862,"TargetProp":0.36085184698304196,"AltProp":0.639148153016958,"TargetPropGoodBad":0.000019017968634028063,"TargetPropGood":0.000019017917642772547,"TargetPropTotal":0.000019017968634028063,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.19017968634028062,"AltFpkm":0.33685014025007076,"TargetFpkmProp":0.360851846983042,"AltFpkmProp":0.639148153016958,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":30000,"End":130000,"TargetType":"paired","AltType":"self","TargetHits":2903,"AltHits":5221,"TargetProp":0.3573362875430822,"AltProp":0.6426637124569178,"TargetPropGoodBad":0.000020112627666514924,"TargetPropGood":0.000020112573740243608,"TargetPropTotal":0.000020112627666514924,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.2011262766651492,"AltFpkm":0.36172245624138616,"TargetFpkmProp":0.3573362875430822,"AltFpkmProp":0.6426637124569178,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":40000,"End":140000,"TargetType":"paired","AltType":"self","TargetHits":3070,"AltHits":5371,"TargetProp":0.363700983295818,"AltProp":0.636299016704182,"TargetPropGoodBad":0.00002126964069452319,"TargetPropGood":0.00002126958366605163,"TargetPropTotal":0.00002126964069452319,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.21269640694523187,"AltFpkm":0.3721147888282868,"TargetFpkmProp":0.363700983295818,"AltFpkmProp":0.636299016704182,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":50000,"End":150000,"TargetType":"paired","AltType":"self","TargetHits":3113,"AltHits":5161,"TargetProp":0.37623882040125695,"AltProp":0.623761179598743,"TargetPropGoodBad":0.000021567554228681007,"TargetPropGood":0.000021567496401439324,"TargetPropTotal":0.000021567554228681007,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.21567554228681005,"AltFpkm":0.357565523206626,"TargetFpkmProp":0.37623882040125695,"AltFpkmProp":0.6237611795987431,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":60000,"End":160000,"TargetType":"paired","AltType":"self","TargetHits":3199,"AltHits":4976,"TargetProp":0.3913149847094801,"AltProp":0.6086850152905199,"TargetPropGoodBad":0.00002216338129699664,"TargetPropGood":0.00002216332187221471,"TargetPropTotal":0.00002216338129699664,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.22163381296996637,"AltFpkm":0.34474831301611525,"TargetFpkmProp":0.3913149847094801,"AltFpkmProp":0.6086850152905199,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":70000,"End":170000,"TargetType":"paired","AltType":"self","TargetHits":3295,"AltHits":5300,"TargetProp":0.3833624200116347,"AltProp":0.6166375799883653,"TargetPropGoodBad":0.000022828490582558276,"TargetPropGood":0.00002282842937447561,"TargetPropTotal":0.000022828490582558276,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.22828490582558275,"AltFpkm":0.3671957514038205,"TargetFpkmProp":0.3833624200116347,"AltFpkmProp":0.6166375799883653,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":80000,"End":180000,"TargetType":"paired","AltType":"self","TargetHits":3471,"AltHits":5717,"TargetProp":0.37777535916412713,"AltProp":0.6222246408358729,"TargetPropGoodBad":0.000024047857606087944,"TargetPropGood":0.00002404779312862059,"TargetPropTotal":0.000024047857606087944,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.2404785760608794,"AltFpkm":0.39608643599540416,"TargetFpkmProp":0.3777753591641271,"AltFpkmProp":0.6222246408358729,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}
{"Genome":"A4","Chr":"2L","Start":90000,"End":190000,"TargetType":"paired","AltType":"self","TargetHits":3365,"AltHits":0,"TargetProp":"NaN","AltProp":0,"TargetPropGoodBad":0.000023313466103280303,"TargetPropGood":0.00002331340359487418,"TargetPropTotal":0.000023313466103280303,"WinSize":100000,"WinStep":10000,"TargetFpkm":0.233134661032803,"AltFpkm":0.3886039565328357,"TargetFpkmProp":0.3749721417428125,"AltFpkmProp":0.6250278582571874,"AltOvlHits":0,"AltNonOvlHits":0,"AltOvlProp":"NaN","AltNonOvlProp":"NaN","AltOvlFpkm":0,"AltNonOvlFpkm":0,"AltOvlFpkmProp":"NaN","AltNonOvlFpkmProp":"NaN","Name":"Iso1 X A4 larval brain \u0026 imaginal discs"}`

func TestEcNorm(t *testing.T) {
	in := strings.NewReader(gPairvizOutExample)
	cchr := "2L"

	enc := json.NewEncoder(os.Stdout)
	enc.SetIndent("", "\t")

	cmean, _, e := GetControlStatMeans(cchr, ParsePairvizOut(in))
	Must(e)
	Must(enc.Encode(cmean))

	in2 := strings.NewReader(gPairvizOutExample)
	it := ParsePairvizOut(in2)
	subit := SubtractControlStatAll(it, cmean)

	subs, e := Collect[JsonOutStat](subit)
	Must(e)
	enc.SetIndent("", "\t")
	for _, sub := range subs {
		Must(enc.Encode(sub))
	}
}
